// app/lib/drillPay2026.ts
// Source: DFAS 2026 Reserve Component Drill Pay tables (Effective Jan 1, 2026).
// Enlisted: https://www.dfas.mil/.../Drill-Pay_E/
// Officers (O-1..O-7): https://www.dfas.mil/.../Drill-Pay-CO/
// Warrant: https://www.dfas.mil/.../Drill-Pay_WO/
// O-1E/O-2E/O-3E: https://www.dfas.mil/.../Drill-Pay-CO_FE/

export const YOS_BOUNDS = [2, 3, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40] as const;

export type PayGrade =
  | `E-${1|2|3|4|5|6|7|8|9}`
  | `W-${1|2|3|4|5}`
  | `O-${1|2|3|4|5|6|7}`
  | `O-1E` | `O-2E` | `O-3E`;

type Row = Array<number | null>;

// Buckets correspond to:
// 0: <=2, 1: <=3, 2: <=4, 3: <=6, 4: <=8, 5: <=10, 6: <=12, 7: <=14, 8: <=16,
// 9: <=18, 10: <=20, 11: <=22, ... 20: <=40, 21: >40
function bucketIndex(yos: number): number {
  for (let i = 0; i < YOS_BOUNDS.length; i++) {
    if (yos <= YOS_BOUNDS[i]) return i;
  }
  return YOS_BOUNDS.length; // >40
}

function nearestDefined(row: Row, idx: number): { value: number; minValidIdx: number } | null {
  if (row[idx] != null) return { value: row[idx] as number, minValidIdx: idx };

  // Prefer nearest lower bucket (more conservative)
  for (let i = idx; i >= 0; i--) {
    if (row[i] != null) return { value: row[i] as number, minValidIdx: i };
  }
  // Otherwise nearest higher bucket
  for (let i = idx; i < row.length; i++) {
    if (row[i] != null) return { value: row[i] as number, minValidIdx: i };
  }
  return null;
}

export function yosLabel(idx: number): string {
  if (idx <= 0) return "2 or less";
  if (idx >= YOS_BOUNDS.length) return "Over 40";
  return `Over ${YOS_BOUNDS[idx - 1]}`;
}

// DFAS “1 Drill” amounts (USD) effective Jan 1, 2026.
// NOTE: some grades (e.g., E-8/E-9/W-5) are not valid at low YOS; those buckets are null.
export const DRILL_2026_1UTA: Record<PayGrade, Row> = {
  // Enlisted (DFAS Drill Pay – Enlisted, Jan 2026)
  "E-1": [80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24,80.24],
  "E-2": [89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93,89.93],
  "E-3": [94.56,100.50,106.60,106.60,106.60,106.60,106.60,106.60,106.60,106.60,106.60,106.60,106.60,106.60,106.60,106.60,106.60,106.60,106.60,106.60,106.60,106.60],
  "E-4": [104.74,110.10,116.08,121.95,127.18,127.18,127.18,127.18,127.18,127.18,127.18,127.18,127.18,127.18,127.18,127.18,127.18,127.18,127.18,127.18,127.18,127.18],
  "E-5": [111.43,119.94,125.86,131.56,137.00,143.33,146.51,147.39,147.39,147.39,147.39,147.39,147.39,147.39,147.39,147.39,147.39,147.39,147.39,147.39,147.39,147.39],
  "E-6": [113.37,124.77,130.27,135.63,141.19,153.76,158.65,168.11,171.01,173.12,175.59,175.59,175.59,175.59,175.59,175.59,175.59,175.59,175.59,175.59,175.59,175.59],
  "E-7": [131.07,143.05,148.54,155.77,161.46,171.19,176.68,186.39,194.50,200.03,205.91,208.19,215.84,219.94,235.58,235.58,235.58,235.58,235.58,235.58,235.58,235.58],
  "E-8": [null,null,null,null,null,188.55,196.90,202.06,208.24,214.94,227.04,233.18,243.61,249.39,263.63,268.91,268.91,268.91,268.91,268.91,268.91,268.91],
  "E-9": [null,null,null,null,null,null,230.34,235.55,242.12,249.87,257.69,270.17,280.77,291.89,308.93,324.34,340.58,357.64,357.64,357.64,357.64,357.64],

  // Warrant Officers (DFAS Drill Pay – Warrant, Jan 2026)
  "W-1": [135.22,149.79,153.70,161.97,171.74,186.14,192.87,202.31,211.55,218.83,225.54,233.67,233.67,233.67,233.67,233.67,233.67,233.67,233.67,233.67,233.67,233.67],
  "W-2": [154.06,168.63,173.11,176.20,186.18,201.70,209.42,216.98,226.25,233.50,240.05,247.90,253.05,257.14,257.14,257.14,257.14,257.14,257.14,257.14,257.14,257.14],
  "W-3": [174.11,181.35,188.81,191.23,199.03,214.37,230.35,237.88,246.59,255.53,271.68,282.55,289.06,295.99,305.42,305.42,305.42,305.42,305.42,305.42,305.42,305.42],
  "W-4": [190.66,205.07,210.95,216.74,226.73,236.60,246.60,261.61,274.79,287.33,297.62,307.63,322.32,334.40,348.18,348.18,355.12,355.12,355.12,355.12,355.12,355.12],
  "W-5": [null,null,null,null,null,null,null,null,null,null,null,338.99,356.19,369.01,383.17,383.17,402.36,402.36,422.45,422.45,443.61,443.61],

  // Officers (DFAS Drill Pay – Officers, Jan 2026)
  "O-1": [138.34,144.00,174.08,174.08,174.08,174.08,174.08,174.08,174.08,174.08,174.08,174.08,174.08,174.08,174.08,174.08,174.08,174.08,174.08,174.08,174.08,174.08],
  "O-2": [159.40,181.54,209.08,216.15,220.59,220.59,220.59,220.59,220.59,220.59,220.59,220.59,220.59,220.59,220.59,220.59,220.59,220.59,220.59,220.59,220.59,220.59],
  "O-3": [184.47,209.13,225.68,246.09,257.90,270.85,279.19,292.94,300.14,300.14,300.14,300.14,300.14,300.14,300.14,300.14,300.14,300.14,300.14,300.14,300.14,300.14],
  "O-4": [209.82,242.88,259.12,262.70,277.74,293.88,314.00,329.61,340.48,346.72,350.33,350.33,350.33,350.33,350.33,350.33,350.33,350.33,350.33,350.33,350.33,350.33],
  "O-5": [243.18,273.94,292.90,296.47,308.32,315.38,330.95,342.39,357.17,379.71,390.46,401.09,413.16,413.16,413.16,413.16,413.16,413.16,413.16,413.16,413.16,413.16],
  "O-6": [291.71,320.46,341.50,341.50,342.81,357.50,359.45,359.45,379.88,415.99,437.18,458.37,470.43,482.64,506.29,506.29,513.61,513.61,513.61,513.61,513.61,513.61],
  "O-7": [384.67,402.54,410.81,417.40,429.29,441.06,454.64,468.19,481.81,524.51,560.59,560.59,560.59,560.59,563.48,563.48,574.74,574.74,574.74,574.74,574.74,574.74],

  // Officers w/ >4 years creditable enlisted service (DFAS Drill Pay – CO_FE, Jan 2026)
  "O-1E": [null,null,174.08,185.89,192.77,199.79,206.69,216.15,216.15,216.15,216.15,216.15,216.15,216.15,216.15,216.15,216.15,216.15,216.15,216.15,216.15,216.15],
  "O-2E": [null,null,null,216.15,220.59,227.60,239.46,248.63,255.45,255.45,255.45,255.45,255.45,255.45,255.45,255.45,255.45,255.45,255.45,255.45,255.45,255.45],
  "O-3E": [null,null,null,null,246.09,257.90,270.85,279.19,292.94,304.57,311.23,320.32,320.32,320.32,320.32,320.32,320.32,320.32,320.32,320.32,320.32,320.32],
};

export function getDrillPay1UTA(payGrade: PayGrade, yos: number): {
  utaPay: number;
  bucket: number;
  bucketLabel: string;
  warning?: string;
} {
  const row = DRILL_2026_1UTA[payGrade];
  const bucket = bucketIndex(yos);
  const picked = nearestDefined(row, bucket);

  if (!picked) {
    return { utaPay: 0, bucket, bucketLabel: yosLabel(bucket), warning: "No pay table match." };
  }

  // If user’s bucket is null and we had to fall back, warn them
  let warning: string | undefined;
  if (row[bucket] == null) {
    warning = `YOS/paygrade combo not shown in DFAS table for this bucket. Using nearest available value (${yosLabel(picked.minValidIdx)}).`;
  }

  return {
    utaPay: picked.value,
    bucket,
    bucketLabel: yosLabel(bucket),
    warning
  };
}
